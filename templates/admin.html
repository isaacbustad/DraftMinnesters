<!DOCTYPE html>
<html>
    <head>
        <title>Admin - Draft Ministers</title>
        <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
        <style>
            .prediction-container {
                max-width: 1200px;
                margin: 2rem auto;
                padding: 0 1rem;
            }
            
            .admin-notice {
                background: #fff3cd;
                border: 2px solid #ffc107;
                border-radius: 12px;
                padding: 1.5rem;
                margin-bottom: 2rem;
                text-align: center;
            }
            
            .admin-notice h2 {
                margin: 0 0 0.5rem 0;
                color: #856404;
            }
            
            .admin-notice p {
                margin: 0;
                color: #856404;
                font-weight: 500;
            }
            
            .teams-section {
                background: #fff;
                border-radius: 20px;
                padding: 2rem;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            }
            
            .teams-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 1.5rem;
                margin-top: 1.5rem;
            }
            
            .team-card {
                background: #f8f9fa;
                border-radius: 12px;
                padding: 1.5rem;
                border: 1px solid #e0e0e0;
                transition: transform 0.2s, box-shadow 0.2s;
            }
            
            .team-card:hover {
                transform: translateY(-4px);
                box-shadow: 0 6px 16px rgba(0,0,0,0.1);
            }
            
            .team-header {
                display: flex;
                align-items: center;
                gap: 1rem;
                margin-bottom: 1rem;
            }
            
            .team-logo {
                width: 60px;
                height: 60px;
                object-fit: contain;
            }
            
            .team-name {
                font-size: 1.1rem;
                font-weight: bold;
                margin: 0;
                flex: 1;
            }
            
            .team-details {
                font-size: 0.9rem;
                color: #666;
            }
            
            .team-details p {
                margin: 0.5rem 0;
            }
            
            .team-code {
                display: inline-block;
                background: #000;
                color: #fff;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 0.85rem;
                font-weight: bold;
            }
            
            .dmr-rating {
                display: inline-block;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: #fff;
                padding: 6px 12px;
                border-radius: 8px;
                font-size: 1rem;
                font-weight: bold;
                margin-top: 0.5rem;
            }
            
            .error-message {
                background: #f8d7da;
                border: 1px solid #f5c6cb;
                color: #721c24;
                padding: 1rem;
                border-radius: 8px;
                margin: 1rem 0;
            }
            
            .teams-count {
                color: #666;
                font-size: 0.9rem;
                margin-bottom: 1rem;
            }
            
            .ml-section {
                background: #fff;
                border-radius: 20px;
                padding: 2rem;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                margin-bottom: 2rem;
            }
            
            .ml-info {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1.5rem;
                flex-wrap: wrap;
                gap: 1rem;
            }
            
            .last-run-info {
                font-size: 1rem;
                color: #666;
            }
            
            .last-run-info strong {
                color: #000;
            }
            
            .get-dmr-btn {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: #fff;
                border: none;
                padding: 0.75rem 2rem;
                border-radius: 8px;
                font-size: 1rem;
                font-weight: bold;
                cursor: pointer;
                transition: transform 0.2s, box-shadow 0.2s;
            }
            
            .get-dmr-btn:hover:not(:disabled) {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            }
            
            .get-dmr-btn:disabled {
                opacity: 0.6;
                cursor: not-allowed;
            }
            
            .progress-section {
                margin-bottom: 1.5rem;
            }
            
            .progress-bar-container {
                width: 100%;
                height: 30px;
                background: #f0f0f0;
                border-radius: 15px;
                overflow: hidden;
                margin-bottom: 0.5rem;
            }
            
            .progress-bar {
                height: 100%;
                background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
                width: 0%;
                transition: width 0.3s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #fff;
                font-weight: bold;
                font-size: 0.9rem;
            }
            
            .progress-text {
                text-align: center;
                font-weight: bold;
                color: #667eea;
                margin-bottom: 0.5rem;
            }
            
            .current-step {
                text-align: center;
                color: #666;
                font-style: italic;
                margin-bottom: 1rem;
            }
            
            .log-section {
                background: #1e1e1e;
                border-radius: 8px;
                padding: 1rem;
                max-height: 400px;
                overflow-y: auto;
            }
            
            .log-section h3 {
                color: #fff;
                margin-top: 0;
                margin-bottom: 1rem;
            }
            
            .log-output {
                font-family: 'Courier New', monospace;
                font-size: 0.85rem;
                color: #d4d4d4;
                line-height: 1.6;
            }
            
            .log-entry {
                margin-bottom: 0.25rem;
                padding: 0.25rem 0;
            }
            
            .log-entry:last-child {
                margin-bottom: 0;
            }
        </style>
    </head>
    <body>
        <header>
            <div class="logo" aria-label="Draft Ministers Logo">
                <a href="/" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 0.75rem;">
                    <img src="{{ url_for('static', filename='images/DM_Logo_W.png') }}" alt="Draft Ministers Logo">
                    <h1>Draft Ministers</h1>
                </a>
            </div>
            <span class="hamburger" onclick="openNav()">&#9776;</span>
        </header>

        <div id="mySidenav" class="sidenav">
            <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
            <a href="/">Home</a>
            <a href="/profile">Profile</a>
            <a href="/admin">Admin</a>
        </div>

        <main class="prediction-container">
            <div class="admin-notice">
                <h2>Administrator Access Only</h2>
                <p>This page is restricted to administrators only.</p>
            </div>

            <section class="ml-section">
                <h2 style="margin-top: 0;">Machine Learning DMR Calculation</h2>
                
                <div class="ml-info">
                    <div class="last-run-info">
                        <strong>Last Run:</strong> 
                        <span id="last-run-time">
                            {% if last_run_time %}
                                {{ last_run_time }}
                            {% else %}
                                Never
                            {% endif %}
                        </span>
                    </div>
                    <button id="get-dmr-btn" class="get-dmr-btn" onclick="startMLProcess()">
                        Get DMR
                    </button>
                </div>

                <div id="ml-progress-container" style="display: none;">
                    <div class="progress-section">
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="progress-bar"></div>
                        </div>
                        <div class="progress-text" id="progress-text">0%</div>
                        <div class="current-step" id="current-step"></div>
                    </div>

                    <div class="log-section">
                        <h3>Output Log</h3>
                        <div class="log-output" id="log-output">
                            <div class="log-entry">Waiting for process to start...</div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="ml-section">
                <h2 style="margin-top: 0;">Upcoming Match Cutoff Date</h2>
                <p style="color: #666; margin-bottom: 1rem;">
                    Set the cutoff date for upcoming matches. Only matches before this date will be considered as upcoming.
                    Since upcoming match data is only in 2023, set this to a date in 2023 (e.g., 2023-12-31).
                </p>
                <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px;">
                        <label for="cutoff-date" style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #333;">
                            Cutoff Date:
                        </label>
                        <input 
                            type="date" 
                            id="cutoff-date" 
                            style="width: 50%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem;"
                        >
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: flex-end;">
                        <button 
                            id="save-cutoff-btn" 
                            class="get-dmr-btn" 
                            onclick="saveCutoffDate()"
                            style="margin: 0;"
                        >
                            Save Cutoff Date
                        </button>
                    </div>
                </div>
                <div id="cutoff-message" style="margin-top: 1rem; padding: 0.75rem; border-radius: 8px; display: none;"></div>
            </section>

            <section class="teams-section">
                <h2 style="margin-top: 0;">Teams in Database</h2>
                
                {% if error %}
                <div class="error-message">
                    <strong>Error:</strong> {{ error }}
                </div>
                {% endif %}
                
                {% if teams %}
                <div class="teams-count">
                    Total teams: {{ teams|length }}
                </div>
                <div class="teams-grid">
                    {% for team in teams %}
                    <div class="team-card">
                        <div class="team-header">
                            {% if team.logo %}
                            <img src="{{ team.logo }}" alt="{{ team.name }}" class="team-logo" onerror="this.style.display='none'">
                            {% endif %}
                            <h3 class="team-name">{{ team.name }}</h3>
                        </div>
                        <div class="team-details">
                            {% if team.dmr is not none %}
                            <p><strong>DMR Rating:</strong> <span class="dmr-rating">{{ "%.2f"|format(team.dmr) }}</span></p>
                            {% endif %}
                            {% if team.code %}
                            <p><span class="team-code">{{ team.code }}</span></p>
                            {% endif %}
                            {% if team.country %}
                            <p><strong>Country:</strong> {{ team.country }}</p>
                            {% endif %}
                            {% if team.founded %}
                            <p><strong>Founded:</strong> {{ team.founded }}</p>
                            {% endif %}
                            {% if team.venue_name %}
                            <p><strong>Venue:</strong> {{ team.venue_name }}</p>
                            {% endif %}
                            {% if team.venue_city %}
                            <p><strong>City:</strong> {{ team.venue_city }}</p>
                            {% endif %}
                            {% if team.venue_capacity %}
                            <p><strong>Capacity:</strong> {{ team.venue_capacity }}</p>
                            {% endif %}
                            {% if team.league %}
                            <p><strong>League:</strong> {{ team.league }}</p>
                            {% endif %}
                            <p><strong>ID:</strong> {{ team.id }}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="error-message">
                    No teams found in the database.
                </div>
                {% endif %}
            </section>
        </main>

        <footer>
            <p>&copy; 2025 Draft Ministers</p>
        </footer>
        <script src="{{ url_for('static', filename='js/nav.js') }}"></script>
        <script>
            let statusPollInterval = null;
            
            // Load cutoff date on page load
            (async function() {
                try {
                    const response = await fetch('/api/admin/cutoff-date');
                    const data = await response.json();
                    if (data.cutoff_date) {
                        document.getElementById('cutoff-date').value = data.cutoff_date;
                    }
                } catch (error) {
                    console.error('Error loading cutoff date:', error);
                }
            })();
            
            function saveCutoffDate() {
                const cutoffDate = document.getElementById('cutoff-date').value;
                const messageDiv = document.getElementById('cutoff-message');
                const btn = document.getElementById('save-cutoff-btn');
                
                if (!cutoffDate) {
                    messageDiv.style.display = 'block';
                    messageDiv.style.background = '#f8d7da';
                    messageDiv.style.border = '1px solid #f5c6cb';
                    messageDiv.style.color = '#721c24';
                    messageDiv.textContent = 'Please select a cutoff date.';
                    return;
                }
                
                btn.disabled = true;
                btn.textContent = 'Saving...';
                
                fetch('/api/admin/cutoff-date', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ cutoff_date: cutoffDate })
                })
                .then(response => response.json())
                .then(data => {
                    messageDiv.style.display = 'block';
                    if (data.error) {
                        messageDiv.style.background = '#f8d7da';
                        messageDiv.style.border = '1px solid #f5c6cb';
                        messageDiv.style.color = '#721c24';
                        messageDiv.textContent = 'Error: ' + data.error;
                    } else {
                        messageDiv.style.background = '#d4edda';
                        messageDiv.style.border = '1px solid #c3e6cb';
                        messageDiv.style.color = '#155724';
                        messageDiv.textContent = 'Cutoff date saved successfully!';
                    }
                    btn.disabled = false;
                    btn.textContent = 'Save Cutoff Date';
                    
                    // Hide message after 3 seconds
                    setTimeout(() => {
                        messageDiv.style.display = 'none';
                    }, 3000);
                })
                .catch(error => {
                    console.error('Error saving cutoff date:', error);
                    messageDiv.style.display = 'block';
                    messageDiv.style.background = '#f8d7da';
                    messageDiv.style.border = '1px solid #f5c6cb';
                    messageDiv.style.color = '#721c24';
                    messageDiv.textContent = 'Error saving cutoff date. Please try again.';
                    btn.disabled = false;
                    btn.textContent = 'Save Cutoff Date';
                });
            }
            
            function startMLProcess() {
                const btn = document.getElementById('get-dmr-btn');
                const container = document.getElementById('ml-progress-container');
                const logOutput = document.getElementById('log-output');
                
                // Disable button and show progress container
                btn.disabled = true;
                btn.textContent = 'Running...';
                container.style.display = 'block';
                logOutput.innerHTML = '<div class="log-entry">Starting ML process...</div>';
                
                // Reset progress
                updateProgress(0, 'Initializing...', []);
                
                // Start the ML process
                fetch('/api/ml/run', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Error: ' + data.error);
                        btn.disabled = false;
                        btn.textContent = 'Get DMR';
                        return;
                    }
                    
                    // Start polling for status
                    startStatusPolling();
                })
                .catch(error => {
                    console.error('Error starting ML process:', error);
                    alert('Error starting ML process. Please try again.');
                    btn.disabled = false;
                    btn.textContent = 'Get DMR';
                });
            }
            
            function startStatusPolling() {
                // Clear any existing interval
                if (statusPollInterval) {
                    clearInterval(statusPollInterval);
                }
                
                // Poll every 500ms
                statusPollInterval = setInterval(() => {
                    fetch('/api/ml/status')
                        .then(response => response.json())
                        .then(data => {
                            updateProgress(
                                data.progress,
                                data.current_step,
                                data.log
                            );
                            
                            // If process is complete, stop polling
                            if (!data.running && data.progress >= 100) {
                                clearInterval(statusPollInterval);
                                statusPollInterval = null;
                                
                                const btn = document.getElementById('get-dmr-btn');
                                btn.disabled = false;
                                btn.textContent = 'Get DMR';
                                
                                // Update last run time
                                if (data.teams_updated > 0) {
                                    // Reload page to show updated DMRs and last run time
                                    setTimeout(() => {
                                        window.location.reload();
                                    }, 2000);
                                }
                            } else if (!data.running && data.progress < 100) {
                                // Process failed or stopped
                                clearInterval(statusPollInterval);
                                statusPollInterval = null;
                                
                                const btn = document.getElementById('get-dmr-btn');
                                btn.disabled = false;
                                btn.textContent = 'Get DMR';
                            }
                        })
                        .catch(error => {
                            console.error('Error polling status:', error);
                        });
                }, 500);
            }
            
            function updateProgress(progress, currentStep, logEntries) {
                const progressBar = document.getElementById('progress-bar');
                const progressText = document.getElementById('progress-text');
                const currentStepEl = document.getElementById('current-step');
                const logOutput = document.getElementById('log-output');
                
                // Update progress bar
                progressBar.style.width = progress + '%';
                progressBar.textContent = progress >= 5 ? progress + '%' : '';
                
                // Update progress text
                progressText.textContent = progress + '%';
                
                // Update current step
                currentStepEl.textContent = currentStep;
                
                // Update log output
                if (logEntries && logEntries.length > 0) {
                    logOutput.innerHTML = logEntries.map(entry => 
                        `<div class="log-entry">${entry}</div>`
                    ).join('');
                    // Scroll to bottom
                    logOutput.scrollTop = logOutput.scrollHeight;
                }
            }
        </script>
    </body>
</html>

