<!DOCTYPE html>
<html>
    <head>
        <title>Draft Ministers App - Soccer Prediction</title>
        <!-- Swiper.js CSS -->
        <link
          rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"
        />
        <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='favicon_io/apple-touch-icon.png') }}">
        <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon_io/favicon-32x32.png') }}">
        <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon_io/favicon-16x16.png') }}">
        <link rel="manifest" href="{{ url_for('static', filename='favicon_io/site.webmanifest') }}">
        
        <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    </head>
    <body>
        <header>
            <div class="logo" aria-label="Draft Ministers Logo">
                <img src="{{ url_for('static', filename='images/DM_Logo_W.png') }}" alt="Draft Ministers Logo" class="DM_logo_w" style="cursor: pointer;" title="Click to refresh data">
                <h1>Draft Ministers</h1>
            </div>
        </header>
        <main>
            <div id ="banner">
                <div class="underdogs-banner card-glass">
                    <p class="card-header">Underdogs to Watch</p>
                    {% if underdog %}
                    <img src="{{ underdog.logo }}" alt="{{ underdog.name }}" class="card-logo" style="margin: auto; height: 50%; width: 80%;">
                    <div class="card-content" style="flex-grow: 0; height: 30%;">
                        <h3 style="margin: 0;">{{ underdog.name }}</h3>
                        <p style="margin: 0.2rem 0;">vs {{ underdog.match_vs }}</p>
                        <small>{{ underdog.match_date }}</small>
                    </div>
                    {% endif %}
                </div>
                <div class="swiper-container-wrapper">
                    <div class="swiper">
                        <div class="swiper-wrapper">
                            {% if matches %}
                                {% for match in matches[:10] %}
                                <div class="swiper-slide card-glass">
                                    <img src="{{ match.home_team.logo }}" alt="{{ match.home_team.name }}" class="swiper-logo" onerror="this.src='{{ url_for('static', filename='images/slide1.jpg') }}'">
                                    <div class="swiper-slide-title">
                                        {{ match.home_team.name }} vs {{ match.away_team.name }}<br>
                                        <span style="font-size: 0.8em; font-weight: normal;">{{ match.date }}</span>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="swiper-slide card-glass"><img src="{{ url_for('static', filename='images/slide1.jpg') }}" alt="Slide 1"><p class="swiper-slide-title">Loading Matches...</p></div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="swiper-pagination"></div>
                    <div class="swiper-button-next"></div>
                    <div class="swiper-button-prev"></div>
                </div>
                <div class="winners-banner card-glass">
                    <p class="card-header">Winners to Watch</p>
                    {% if winner %}
                    <img src="{{ winner.logo }}" alt="{{ winner.name }}" class="card-logo" style="margin: auto; height: 50%; width: 80%;">
                    <div class="card-content" style="flex-grow: 0; height: 30%;">
                        <h3 style="margin: 0;">{{ winner.name }}</h3>
                        <p style="margin: 0.2rem 0;">vs {{ winner.match_vs }}</p>
                        <small>{{ winner.match_date }}</small>
                    </div>
                    {% endif %}
                </div>
            </div>
            

<!-- TABS -->
<nav class="navigation" role="tablist" aria-label="Match filters">
  <button role="tab" class="nav-links active" aria-selected="true"
          onclick="toggleNav(event, 'upcoming-matches-container')">
    Upcoming Matches
  </button>
  <button role="tab" class="nav-links"
          onclick="toggleNav(event, 'most-likely-to-win-container')">
    Most Likely to Win
  </button>
  <button role="tab" class="nav-links"
          onclick="toggleNav(event, 'most-likely-to-lose-container')">
    Most Likely to Lose
  </button>
  <button role="tab" class="nav-links"
          onclick="toggleNav(event, 'starred-container')">
    Starred
  </button>
</nav>

<!-- PANELS -->
<div id="upcoming-matches-container" class="nav-content" style="display:block" aria-labelledby="tab-upcoming">
  <h2>Upcoming Matches</h2>
  <p>Your one-stop solution for soccer match predictions.</p>

  <div class="matches-grid" id="upcoming-matches-grid">
    <div class="loading">Loading matches...</div>
  </div>
</div>

<div id="most-likely-to-win-container" class="nav-content" aria-labelledby="tab-most-likely">
  <h2>Most Likely to Win</h2>
  <p>Discover the teams with the highest chances of winning their upcoming matches.</p>

  <div class="matches-grid" id="most-likely-to-win-grid">
    <div class="loading">Loading matches...</div>
  </div>
</div>

<div id="most-likely-to-lose-container" class="nav-content" aria-labelledby="tab-least-likely">
  <h2>Most Likely to Lose</h2>
  <p>Find out which teams are predicted to face tough challenges in their next games.</p>

  <div class="matches-grid" id="most-likely-to-lose-grid">
    <div class="loading">Loading matches...</div>
  </div>
</div>

<div id="starred-container" class="nav-content" aria-labelledby="tab-starred">
  <h2>Starred</h2>
  <p>Matches you’ve saved.</p>
  <div class="matches-grid">
    <div class="empty-note">No matches starred yet.</div>
  </div>
</div>

        </main>
        <footer>
            <p>&copy; 2025 Draft Ministers</p>
        </footer>
        <script src="{{ url_for('static', filename='js/nav.js') }}"></script>
        <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
        <script>
            // Initialize banner slider
            var bannerSwiper = new Swiper('.swiper', {
                loop: true,
                effect: "coverflow",
                grabCursor: true,
                centeredSlides: true,
                slidesPerView: "3",
                pagination: {
                    el: '.swiper-pagination',
                },
                // Coverflow effect parameters
                coverflowEffect: {
                    rotate: 50,
                    stretch: 0,
                    depth: 100,
                    modifier: 1,
                    slideShadows: true,
                },
                navigation: {
                    nextEl: '.swiper-button-next',
                    prevEl: '.swiper-button-prev',
                },
                autoplay: {
                    delay: 5000,
                },
            });
        </script>
        <script>
            // ---- Fetch and render matches ----
            async function fetchMatches() {
                try {
                    const response = await fetch('/api/matches');
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('Error fetching matches:', error);
                    return null;
                }
            }

            function createMatchCard(match, badgeClass = '', badgeText = 'Upcoming') {
                const matchId = `match-${match.id}`;
                const homeCode = match.home_team.code || match.home_team.name.substring(0, 3).toUpperCase();
                const awayCode = match.away_team.code || match.away_team.name.substring(0, 3).toUpperCase();
                
                return `
                    <article class="match-card" data-match-id="${match.id}">
                        <header>
                            <div>${homeCode} vs ${awayCode}</div>
                            <span class="badge ${badgeClass}">${badgeText}</span>
                        </header>
                        <div class="card-body">
                            <div class="row">
                                <div class="team">
                                    <img src="${match.home_team.logo}" alt="${match.home_team.name}" class="team-logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <div class="crest" style="display:none;">${homeCode[0]}</div>
                                    <div>${match.home_team.name}</div>
                                </div>
                                <div>${match.home_team.win_percentage}%</div>
                            </div>
                            <div class="row">
                                <div class="team">
                                    <img src="${match.away_team.logo}" alt="${match.away_team.name}" class="team-logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <div class="crest" style="display:none;">${awayCode[0]}</div>
                                    <div>${match.away_team.name}</div>
                                </div>
                                <div>${match.away_team.win_percentage}%</div>
                            </div>
                            <div class="row note">
                                <div>Draw</div>
                                <div>${match.draw_percentage}%</div>
                            </div>
                        </div>
                        <div class="meta">
                            <div>${match.date || 'TBD'}</div>
                            <button class="star-btn" data-id="${matchId}" aria-label="Star match">☆</button>
                        </div>
                    </article>
                `;
            }

            // Store all matches data for pagination
            const matchesData = {
                'upcoming-matches-grid': { all: [], displayed: 0, badgeClass: '', badgeText: 'Upcoming' },
                'most-likely-to-win-grid': { all: [], displayed: 0, badgeClass: 'win', badgeText: 'Likely win' },
                'most-likely-to-lose-grid': { all: [], displayed: 0, badgeClass: 'lose', badgeText: 'Likely lose' }
            };

            const CARDS_PER_ROW = 3;
            const INITIAL_ROWS = 3;
            const INITIAL_CARDS = INITIAL_ROWS * CARDS_PER_ROW;
            const CARDS_PER_LOAD = INITIAL_CARDS;

            function renderMatches(containerId, matches, badgeClass = '', badgeText = 'Upcoming') {
                const container = document.getElementById(containerId);
                if (!container) return;

                if (!matches || matches.length === 0) {
                    container.innerHTML = '<div class="empty-note">No matches available.</div>';
                    matchesData[containerId] = { all: [], displayed: 0, badgeClass, badgeText };
                    return;
                }

                // Store all matches
                matchesData[containerId] = {
                    all: matches,
                    displayed: Math.min(INITIAL_CARDS, matches.length),
                    badgeClass,
                    badgeText
                };

                // Render initial cards
                renderMatchesPage(containerId);
            }

            function renderMatchesPage(containerId) {
                const data = matchesData[containerId];
                if (!data || !data.all.length) return;

                const container = document.getElementById(containerId);
                const cardsToShow = data.all.slice(0, data.displayed);
                
                container.innerHTML = cardsToShow.map(match => 
                    createMatchCard(match, data.badgeClass, data.badgeText)
                ).join('');

                // Add or update Load More button
                const parentContainer = container.closest('.nav-content');
                if (parentContainer) {
                    let loadMoreBtn = parentContainer.querySelector('.load-more-btn');
                    
                    if (data.displayed < data.all.length) {
                        if (!loadMoreBtn) {
                            loadMoreBtn = document.createElement('button');
                            loadMoreBtn.className = 'load-more-btn';
                            loadMoreBtn.textContent = 'Load More';
                            loadMoreBtn.onclick = () => loadMoreMatches(containerId);
                            parentContainer.appendChild(loadMoreBtn);
                        }
                        loadMoreBtn.style.display = 'block';
                    } else {
                        if (loadMoreBtn) {
                            loadMoreBtn.style.display = 'none';
                        }
                    }
                }

                // Re-initialize star system after rendering
                initializeStarSystem();
            }

            function loadMoreMatches(containerId) {
                const data = matchesData[containerId];
                if (!data) return;

                data.displayed = Math.min(data.displayed + CARDS_PER_LOAD, data.all.length);
                renderMatchesPage(containerId);
            }

            // ---- Star system for cards ----
            function initializeStarSystem() {
                const STAR_KEY = 'dm-stars';
                const starredSet = new Set(JSON.parse(localStorage.getItem(STAR_KEY) || '[]'));
                const starButtons = Array.from(document.querySelectorAll('.match-card .star-btn'));
                const starredGrid = document.querySelector('#starred-container .matches-grid');

                // Reflect current state on buttons
                function paintButtons() {
                    starButtons.forEach(btn => {
                        btn.textContent = starredSet.has(btn.dataset.id) ? '★' : '☆';
                        btn.setAttribute('aria-pressed', starredSet.has(btn.dataset.id) ? 'true' : 'false');
                        btn.title = starredSet.has(btn.dataset.id) ? 'Unstar' : 'Star';
                    });
                }

                // Render the Starred tab grid
                function renderStarred() {
                    if (!starredGrid) return;
                    const ids = [...starredSet];
                    if (!ids.length) {
                        starredGrid.innerHTML = '<div class="empty-note">No matches starred yet.</div>';
                        return;
                    }
                    // Find matching cards and clone them
                    const clones = ids.map(id => {
                        const btn = starButtons.find(b => b.dataset.id === id);
                        return btn ? btn.closest('.match-card').cloneNode(true) : null;
                    }).filter(Boolean);

                    starredGrid.innerHTML = '';
                    clones.forEach(node => {
                        const b = node.querySelector('.star-btn');
                        if (b) { 
                            b.textContent = '★'; 
                            b.disabled = true; 
                            b.style.opacity = 0.6; 
                        }
                        starredGrid.appendChild(node);
                    });
                }

                function save() { 
                    localStorage.setItem(STAR_KEY, JSON.stringify([...starredSet])); 
                }

                function toggle(id) {
                    if (starredSet.has(id)) starredSet.delete(id); 
                    else starredSet.add(id);
                    save(); 
                    paintButtons(); 
                    renderStarred();
                }

                // Hook clicks
                starButtons.forEach(btn => {
                    btn.removeEventListener('click', btn._clickHandler);
                    btn._clickHandler = () => toggle(btn.dataset.id);
                    btn.addEventListener('click', btn._clickHandler);
                });

                // Initial paint
                paintButtons();
                renderStarred();
            }

            // Load matches on page load
            (async function() {
                const data = await fetchMatches();
                if (data) {
                    renderMatches('upcoming-matches-grid', data.upcoming, '', 'Upcoming');
                    renderMatches('most-likely-to-win-grid', data.most_likely_to_win, 'win', 'Likely win');
                    renderMatches('most-likely-to-lose-grid', data.most_likely_to_lose, 'lose', 'Likely lose');
                } else {
                    document.getElementById('upcoming-matches-grid').innerHTML = '<div class="empty-note">Failed to load matches. Please try again later.</div>';
                    document.getElementById('most-likely-to-win-grid').innerHTML = '<div class="empty-note">Failed to load matches. Please try again later.</div>';
                    document.getElementById('most-likely-to-lose-grid').innerHTML = '<div class="empty-note">Failed to load matches. Please try again later.</div>';
                }
            })();

            // Secret button functionality - refresh data
            document.querySelector('.DM_logo_w')?.addEventListener('click', async function() {
                if (!confirm('This will clear the database and fetch fresh data from the API. Continue?')) {
                    return;
                }
                
                const button = this;
                const originalTitle = button.title;
                button.style.opacity = '0.6';
                button.title = 'Refreshing...';
                
                try {
                    const response = await fetch('/api/refresh-data', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        alert(`Data refreshed successfully!\nTeams: ${data.teams_count}\nFixtures: ${data.fixtures_count}`);
                        // Reload matches
                        const matchesData = await fetchMatches();
                        if (matchesData) {
                            renderMatches('upcoming-matches-grid', matchesData.upcoming, '', 'Upcoming');
                            renderMatches('most-likely-to-win-grid', matchesData.most_likely_to_win, 'win', 'Likely win');
                            renderMatches('most-likely-to-lose-grid', matchesData.most_likely_to_lose, 'lose', 'Likely lose');
                        }
                    } else {
                        alert(`Error: ${data.error || 'Failed to refresh data'}`);
                    }
                } catch (error) {
                    console.error('Error refreshing data:', error);
                    alert('Failed to refresh data. Please try again.');
                } finally {
                    button.style.opacity = '1';
                    button.title = originalTitle;
                }
            });
        </script>

    </body>
    </html>