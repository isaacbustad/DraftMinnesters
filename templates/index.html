<!DOCTYPE html>
<html>
    <head>
        <title>Draft Ministers App - Soccer Prediction</title>
        <!-- Swiper.js CSS -->
        <link
          rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"
        />
        <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='favicon_io/apple-touch-icon.png') }}">
        <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon_io/favicon-32x32.png') }}">
        <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon_io/favicon-16x16.png') }}">
        <link rel="manifest" href="{{ url_for('static', filename='favicon_io/site.webmanifest') }}">
        
        <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
        <link rel="stylesheet" href="{{ url_for('static', filename='css/overlaystyles.css') }}">
    </head>
    <body>
        <header>
            <div class="logo" aria-label="Draft Ministers Logo">
                <img src="{{ url_for('static', filename='images/DM_Logo_W.png') }}" alt="Draft Ministers Logo" class="DM_logo_w" style="cursor: pointer;" title="Click to refresh data">
                <h1>Draft Ministers</h1>
            </div>
            <span class="hamburger" onclick="openNav()">&#9776;</span>
        </header>

        <div id="mySidenav" class="sidenav">
            <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
            <a href="/">Home</a>
            <a href="/profile">Profile</a>
            <a href="/admin">Admin</a>
        </div>
        <main>
            <div id ="banner">
                <div class="underdogs-banner card-glass">
                    <p class="card-header">Underdogs to Watch</p>
                    {% if underdog %}
                    <img src="{{ underdog.logo }}" alt="{{ underdog.name }}" class="card-logo" style="margin: auto; height: 50%; width: 80%;">
                    <div class="card-content" style="flex-grow: 0; height: 30%;">
                        <h3 style="margin: 0;">{{ underdog.name }}</h3>
                        <p style="margin: 0.2rem 0;">vs {{ underdog.match_vs }}</p>
                        <small>{{ underdog.match_date }}</small>
                    </div>
                    {% endif %}
                </div>
                <div class="swiper-container-wrapper">
                    <div class="swiper">
                        <div class="swiper-wrapper">
                            {% if matches %}
                                {% for match in matches[:10] %}
                                <div class="swiper-slide card-glass">
                                    <img src="{{ match.home_team.logo }}" alt="{{ match.home_team.name }}" class="swiper-logo" onerror="this.src='{{ url_for('static', filename='images/slide1.jpg') }}'">
                                    <div class="swiper-slide-title">
                                        {{ match.home_team.name }} vs {{ match.away_team.name }}<br>
                                        <span style="font-size: 0.8em; font-weight: normal;">{{ match.date }}</span>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="swiper-slide card-glass"><img src="{{ url_for('static', filename='images/slide1.jpg') }}" alt="Slide 1"><p class="swiper-slide-title">Loading Matches...</p></div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="swiper-pagination"></div>
                    <div class="swiper-button-next"></div>
                    <div class="swiper-button-prev"></div>
                </div>
                <div class="winners-banner card-glass">
                    <p class="card-header">Winners to Watch</p>
                    {% if winner %}
                    <img src="{{ winner.logo }}" alt="{{ winner.name }}" class="card-logo" style="margin: auto; height: 50%; width: 80%;">
                    <div class="card-content" style="flex-grow: 0; height: 30%;">
                        <h3 style="margin: 0;">{{ winner.name }}</h3>
                        <p style="margin: 0.2rem 0;">vs {{ winner.match_vs }}</p>
                        <small>{{ winner.match_date }}</small>
                    </div>
                    {% endif %}
                </div>
            </div>
            

<!-- TABS -->
<nav class="navigation" role="tablist" aria-label="Match filters">
  <button role="tab" class="nav-links active" aria-selected="true"
          onclick="toggleNav(event, 'upcoming-matches-container')">
    Upcoming Matches
  </button>
  <button role="tab" class="nav-links"
          onclick="toggleNav(event, 'past-matches-container')">
    Past Matches
  </button>
  <button role="tab" class="nav-links"
          onclick="toggleNav(event, 'most-likely-to-win-container')">
    Most Likely to Win
  </button>
  <button role="tab" class="nav-links"
          onclick="toggleNav(event, 'most-likely-to-lose-container')">
    Most Likely to Lose
  </button>
  <button role="tab" class="nav-links"
          onclick="toggleNav(event, 'starred-container')">
    Starred
  </button>
</nav>

  <!-- Filter Controls -->
  <div class="filters-container" style="background: #ffffff; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin: 0 1.5rem 1.5rem 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap; align-items: end;">
    <div style="flex: 1; min-width: 200px;">
        <label for="filter-home" style="display: block; font-size: 0.9rem; margin-bottom: 0.5rem; font-weight: bold;">Home Team</label>
        <input type="text" id="filter-home" placeholder="Search home team..." style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box;">
    </div>
    <div style="flex: 1; min-width: 200px;">
        <label for="filter-away" style="display: block; font-size: 0.9rem; margin-bottom: 0.5rem; font-weight: bold;">Away Team</label>
        <input type="text" id="filter-away" placeholder="Search away team..." style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box;">
    </div>
    <div style="flex: 1; min-width: 150px;">
        <label for="filter-date" style="display: block; font-size: 0.9rem; margin-bottom: 0.5rem; font-weight: bold;">Date</label>
        <input type="date" id="filter-date" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box;">
    </div>
    <div style="flex: 1; min-width: 150px;">
        <label for="filter-chance" style="display: block; font-size: 0.9rem; margin-bottom: 0.5rem; font-weight: bold;">Min Win Chance %</label>
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <input type="range" id="filter-chance" min="0" max="100" value="0" style="flex: 1;">
            <span id="filter-chance-val" style="font-weight: bold; min-width: 2.5rem;">0%</span>
        </div>
    </div>
    <div style="flex: 0 0 auto;">
        <button onclick="clearFilters()" style="padding: 0.75rem 1.5rem; background: #f4f4f4; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; font-weight: bold;">Clear</button>
    </div>
  </div>

<!-- PANELS -->
<div id="upcoming-matches-container" class="nav-content" style="display:block" aria-labelledby="tab-upcoming">
  <h2>Upcoming Matches</h2>
  <p>Your one-stop solution for soccer match predictions.</p>

  <div class="matches-grid" id="upcoming-matches-grid">
    <div class="loading">Loading matches...</div>
  </div>
</div>

<div id="past-matches-container" class="nav-content" aria-labelledby="tab-past">
  <h2>Past Matches</h2>
  <p>View completed matches and their results.</p>

  <div class="matches-grid" id="past-matches-grid">
    <div class="loading">Loading matches...</div>
  </div>
</div>

<div id="most-likely-to-win-container" class="nav-content" aria-labelledby="tab-most-likely">
  <h2>Most Likely to Win</h2>
  <p>Discover the teams with the highest chances of winning their upcoming matches.</p>

  <div class="matches-grid" id="most-likely-to-win-grid">
    <div class="loading">Loading matches...</div>
  </div>
</div>

<div id="most-likely-to-lose-container" class="nav-content" aria-labelledby="tab-least-likely">
  <h2>Most Likely to Lose</h2>
  <p>Find out which teams are predicted to face tough challenges in their next games.</p>

  <div class="matches-grid" id="most-likely-to-lose-grid">
    <div class="loading">Loading matches...</div>
  </div>
</div>

<div id="starred-container" class="nav-content" aria-labelledby="tab-starred">
  <h2>Starred</h2>
  <p>Matches you’ve saved.</p>
  <div class="matches-grid" id="starred-grid">
    <div class="empty-note">No matches starred yet.</div>
  </div>
</div>

            <!-- Match Details Overlay -->
            <div id="overlay">
                <div id="overlay-content">
                    <div class="overlay-header">
                        <h2 id="overlay-header-title">Match Details</h2>
                        <button class="overlay-close" onclick="closeOverlay()" aria-label="Close overlay">&times;</button>
                    </div>
                    <div class="overlay-body">
                        <div class="match-overview">
                            <div class="team-section">
                                <img id="team1-logo" src="" alt="" class="team-logo-large">
                                <div id="team1-fallback" class="crest" style="display:none; width:120px; height:120px; margin:0 auto 1rem; font-size:3rem;"></div>
                                <h3 id="team1-name" class="team-name"></h3>
                                <div id="team1-win-pct" class="win-percentage"></div>
                            </div>
                            <div class="vs-section">
                                <div>VS</div>
                                <div class="probability-scale">
                                    <div id="probability-bar" class="probability-bar"></div>
                                </div>
                                <div style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">
                                    <span id="detail-draw">0%</span> Draw
                                </div>
                            </div>
                            <div class="team-section">
                                <img id="team2-logo" src="" alt="" class="team-logo-large">
                                <div id="team2-fallback" class="crest" style="display:none; width:120px; height:120px; margin:0 auto 1rem; font-size:3rem;"></div>
                                <h3 id="team2-name" class="team-name"></h3>
                                <div id="team2-win-pct" class="win-percentage"></div>
                            </div>
                        </div>

                        <div class="match-details">
                            <div class="detail-card">
                                <h4>League</h4>
                                <p id="detail-league">-</p>
                            </div>
                            <div class="detail-card">
                                <h4>Round</h4>
                                <p id="detail-round">-</p>
                            </div>
                            <div class="detail-card">
                                <h4>Venue</h4>
                                <p id="detail-venue">-</p>
                            </div>
                            <div class="detail-card">
                                <h4>Referee</h4>
                                <p id="detail-referee">-</p>
                            </div>
                            <div class="detail-card">
                                <h4>Date</h4>
                                <p id="detail-date">-</p>
                            </div>
                            <div class="detail-card">
                                <h4>Status</h4>
                                <p id="detail-status">-</p>
                            </div>
                        </div>

                        <div class="stats-grid">
                            <div class="stats-section">
                                <h4 id="team1-stats-title">Team Stats</h4>
                                <ul class="stats-list">
                                    <li class="empty-stats">Stats coming soon</li>
                                </ul>
                            </div>
                            <div class="stats-section">
                                <h4 id="team2-stats-title">Team Stats</h4>
                                <ul class="stats-list">
                                    <li class="empty-stats">Stats coming soon</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <footer>
            <p>&copy; 2025 Draft Ministers</p>
        </footer>
        <script src="{{ url_for('static', filename='js/nav.js') }}"></script>
        <script src="{{ url_for('static', filename='js/overlay.js') }}"></script>
        <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
        <script>
            // Initialize banner slider
            var bannerSwiper = new Swiper('.swiper', {
                loop: true,
                effect: "coverflow",
                grabCursor: true,
                centeredSlides: true,
                slidesPerView: "3",
                pagination: {
                    el: '.swiper-pagination',
                },
                // Coverflow effect parameters
                coverflowEffect: {
                    rotate: 50,
                    stretch: 0,
                    depth: 100,
                    modifier: 1,
                    slideShadows: true,
                },
                navigation: {
                    nextEl: '.swiper-button-next',
                    prevEl: '.swiper-button-prev',
                },
                autoplay: {
                    delay: 5000,
                },
            });
        </script>
        <script>
            // ---- Fetch and render matches ----
            async function fetchMatches() {
                try {
                    const response = await fetch('/api/matches');
                    const data = await response.json();
                    
                    // Populate global map
                    if (data) {
                        const allLists = [
                            ...(data.upcoming || []), 
                            ...(data.past || []),
                            ...(data.most_likely_to_win || []), 
                            ...(data.most_likely_to_lose || [])
                        ];
                        allLists.forEach(m => allMatchesMap.set(String(m.id), m));
                    }
                    
                    return data;
                } catch (error) {
                    console.error('Error fetching matches:', error);
                    return null;
                }
            }

            function createMatchCard(match, badgeClass = '', badgeText = 'Upcoming') {
                const matchId = `match-${match.id}`;
                const homeCode = match.home_team.code || match.home_team.name.substring(0, 3).toUpperCase();
                const awayCode = match.away_team.code || match.away_team.name.substring(0, 3).toUpperCase();
                
                return `
                    <article class="match-card" data-match-id="${match.id}" data-match-data='${JSON.stringify(match).replace(/'/g, "&#39;")}' onclick="handleMatchCardClick(this)">
                        <header>
                            <div>${homeCode} vs ${awayCode}</div>
                            <span class="badge ${badgeClass}">${badgeText}</span>
                        </header>
                        <div class="card-body">
                            <div class="row">
                                <div class="team">
                                    <img src="${match.home_team.logo}" alt="${match.home_team.name}" class="team-logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <div class="crest" style="display:none;">${homeCode[0]}</div>
                                    <div>${match.home_team.name}</div>
                                </div>
                                <div>${match.home_team.win_percentage}%</div>
                            </div>
                            <div class="row">
                                <div class="team">
                                    <img src="${match.away_team.logo}" alt="${match.away_team.name}" class="team-logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <div class="crest" style="display:none;">${awayCode[0]}</div>
                                    <div>${match.away_team.name}</div>
                                </div>
                                <div>${match.away_team.win_percentage}%</div>
                            </div>
                            <div class="row note">
                                <div>Draw</div>
                                <div>${match.draw_percentage}%</div>
                            </div>
                        </div>
                        <div class="meta">
                            <div>${match.date || 'TBD'}</div>
                            <button class="star-btn" data-id="${matchId}" aria-label="Star match" onclick="event.stopPropagation()">☆</button>
                        </div>
                    </article>
                `;
            }

            // Store all matches data for pagination
            const matchesData = {
                'upcoming-matches-grid': { all: [], filtered: [], displayed: 0, badgeClass: '', badgeText: 'Upcoming' },
                'most-likely-to-win-grid': { all: [], filtered: [], displayed: 0, badgeClass: 'win', badgeText: 'Likely win' },
                'most-likely-to-lose-grid': { all: [], filtered: [], displayed: 0, badgeClass: 'lose', badgeText: 'Likely lose' },
                'starred-grid': { all: [], filtered: [], displayed: 0, badgeClass: 'star', badgeText: 'Starred' }
            };
            
            // Global map for quick lookup
            const allMatchesMap = new Map();

            const CARDS_PER_ROW = 3;
            const INITIAL_ROWS = 3;
            const INITIAL_CARDS = INITIAL_ROWS * CARDS_PER_ROW;
            const CARDS_PER_LOAD = INITIAL_CARDS;

            function renderMatches(containerId, matches, badgeClass = '', badgeText = 'Upcoming') {
                const container = document.getElementById(containerId);
                if (!container) return;

                if (!matches || matches.length === 0) {
                    container.innerHTML = '<div class="empty-note">No matches available.</div>';
                    matchesData[containerId] = { all: [], filtered: [], displayed: 0, badgeClass, badgeText };
                    return;
                }

                // Store all matches
                matchesData[containerId] = {
                    all: matches,
                    filtered: matches, // Initially filtered is same as all
                    displayed: Math.min(INITIAL_CARDS, matches.length),
                    badgeClass,
                    badgeText
                };

                // Render initial cards
                renderMatchesPage(containerId);
            }

            function renderMatchesPage(containerId) {
                const data = matchesData[containerId];
                // Use filtered data
                if (!data || !data.filtered.length) {
                    const container = document.getElementById(containerId);
                    container.innerHTML = '<div class="empty-note">No matches found.</div>';
                    // Remove load more button if exists
                    const parentContainer = container.closest('.nav-content');
                    const loadMoreBtn = parentContainer?.querySelector('.load-more-btn');
                    if (loadMoreBtn) loadMoreBtn.style.display = 'none';
                    return;
                }

                const container = document.getElementById(containerId);
                const cardsToShow = data.filtered.slice(0, data.displayed);
                
                container.innerHTML = cardsToShow.map(match => 
                    createMatchCard(match, data.badgeClass, data.badgeText)
                ).join('');

                // Add or update Load More button
                const parentContainer = container.closest('.nav-content');
                if (parentContainer) {
                    let loadMoreBtn = parentContainer.querySelector('.load-more-btn');
                    
                    if (data.displayed < data.filtered.length) {
                        if (!loadMoreBtn) {
                            loadMoreBtn = document.createElement('button');
                            loadMoreBtn.className = 'load-more-btn';
                            loadMoreBtn.textContent = 'Load More';
                            loadMoreBtn.onclick = () => loadMoreMatches(containerId);
                            parentContainer.appendChild(loadMoreBtn);
                        }
                        loadMoreBtn.style.display = 'block';
                    } else {
                        if (loadMoreBtn) {
                            loadMoreBtn.style.display = 'none';
                        }
                    }
                }

                // Re-initialize star system after rendering
                bindStarButtons();
            }

            function loadMoreMatches(containerId) {
                const data = matchesData[containerId];
                if (!data) return;

                data.displayed = Math.min(data.displayed + CARDS_PER_LOAD, data.filtered.length);
                renderMatchesPage(containerId);
            }

            // ---- Filtering Logic ----
            // Attach event listeners to inputs
            const filterInputs = ['filter-home', 'filter-away', 'filter-date', 'filter-chance'];
            filterInputs.forEach(id => {
                document.getElementById(id)?.addEventListener('input', applyFilters);
            });

            function applyFilters() {
                const homeQuery = document.getElementById('filter-home').value.toLowerCase();
                const awayQuery = document.getElementById('filter-away').value.toLowerCase();
                const dateQuery = document.getElementById('filter-date').value;
                const chanceQuery = parseInt(document.getElementById('filter-chance').value) || 0;

                // Update chance display
                document.getElementById('filter-chance-val').textContent = chanceQuery + '%';

                // Apply to ALL grids
                Object.keys(matchesData).forEach(containerId => {
                    const data = matchesData[containerId];
                    if (!data || !data.all.length) return;

                    // Skip filtering for most likely to win/lose and starred tabs
                    if (containerId !== 'upcoming-matches-grid') {
                        data.filtered = data.all;
                        data.displayed = Math.min(INITIAL_CARDS, data.filtered.length);
                        renderMatchesPage(containerId);
                        return;
                    }

                    data.filtered = data.all.filter(match => {
                        const homeName = match.home_team.name.toLowerCase();
                        const awayName = match.away_team.name.toLowerCase();
                        const matchDate = match.date.split(' ')[0]; // Assuming YYYY-MM-DD HH:MM
                        // Max win percentage between home and away
                        const maxChance = Math.max(match.home_team.win_percentage, match.away_team.win_percentage);

                        const matchHome = !homeQuery || homeName.includes(homeQuery);
                        const matchAway = !awayQuery || awayName.includes(awayQuery);
                        const matchDateFilter = !dateQuery || matchDate === dateQuery;
                        const matchChance = maxChance >= chanceQuery;

                        return matchHome && matchAway && matchDateFilter && matchChance;
                    });

                    // Reset display count and re-render
                    data.displayed = Math.min(INITIAL_CARDS, data.filtered.length);
                    renderMatchesPage(containerId);
                });
            }

            function clearFilters() {
                document.getElementById('filter-home').value = '';
                document.getElementById('filter-away').value = '';
                document.getElementById('filter-date').value = '';
                document.getElementById('filter-chance').value = 0;
                applyFilters(); // Re-apply (which will reset to all)
            }

            // ---- Star system functions ----
            const STAR_KEY = 'dm-stars';

            function getStarredSet() {
                return new Set(JSON.parse(localStorage.getItem(STAR_KEY) || '[]'));
            }

            function saveStarredSet(set) {
                localStorage.setItem(STAR_KEY, JSON.stringify([...set]));
            }

            // Updates the Starred Grid based on current starred set
            function updateStarredGrid() {
                const starredSet = getStarredSet();
                const starredMatches = [];
                
                starredSet.forEach(idStr => {
                    const id = idStr.replace('match-', '');
                    const match = allMatchesMap.get(id);
                    if (match) starredMatches.push(match);
                });
                
                matchesData['starred-grid'].all = starredMatches;
                
                // Apply filters if active, otherwise just show
                const hasFilter = document.getElementById('filter-home').value || 
                                  document.getElementById('filter-away').value || 
                                  document.getElementById('filter-date').value || 
                                  parseInt(document.getElementById('filter-chance').value) > 0;
                
                if (hasFilter) {
                    // Re-run applyFilters which covers all grids including starred
                    applyFilters();
                } else {
                    matchesData['starred-grid'].filtered = starredMatches;
                    matchesData['starred-grid'].displayed = Math.min(INITIAL_CARDS, starredMatches.length);
                    renderMatchesPage('starred-grid');
                }
            }

            // Toggle star status
            function toggleStar(id) {
                const starredSet = getStarredSet();
                if (starredSet.has(id)) starredSet.delete(id); 
                else starredSet.add(id);
                
                saveStarredSet(starredSet);
                
                // Update ALL star buttons in UI immediately
                bindStarButtons(); 
                
                // Update the starred grid content
                updateStarredGrid();
            }

            // Bind click events and update visual state of star buttons
            function bindStarButtons() {
                const starredSet = getStarredSet();
                const starButtons = Array.from(document.querySelectorAll('.match-card .star-btn'));
                
                starButtons.forEach(btn => {
                    // Update visual state
                    const isStarred = starredSet.has(btn.dataset.id);
                    btn.textContent = isStarred ? '★' : '☆';
                    btn.setAttribute('aria-pressed', isStarred ? 'true' : 'false');
                    btn.title = isStarred ? 'Unstar' : 'Star';
                    
                    // Update listener
                    btn.onclick = (e) => {
                        e.stopPropagation(); // Prevent overlay opening
                        toggleStar(btn.dataset.id);
                    };
                });
            }

            // Handle match card click to show overlay
            function handleMatchCardClick(cardElement) {
                const matchData = cardElement.getAttribute('data-match-data');
                if (matchData) {
                    try {
                        const match = JSON.parse(matchData);
                        showMatchDetails(match);
                    } catch (e) {
                        console.error('Error parsing match data:', e);
                    }
                }
            }


            // Load matches on page load
            (async function() {
                const data = await fetchMatches();
                if (data) {
                    renderMatches('upcoming-matches-grid', data.upcoming, '', 'Upcoming');
                    renderMatches('past-matches-grid', data.past || [], 'past', 'Past');
                    renderMatches('most-likely-to-win-grid', data.most_likely_to_win, 'win', 'Likely win');
                    renderMatches('most-likely-to-lose-grid', data.most_likely_to_lose, 'lose', 'Likely lose');
                    
                    // Initial load of starred matches
                    updateStarredGrid();
                } else {
                    ['upcoming-matches-grid', 'past-matches-grid', 'most-likely-to-win-grid', 'most-likely-to-lose-grid', 'starred-grid'].forEach(id => {
                         const el = document.getElementById(id);
                         if(el) el.innerHTML = '<div class="empty-note">Failed to load matches. Please try again later.</div>';
                    });
                }
            })();

            // Secret button functionality - refresh data
            document.querySelector('.DM_logo_w')?.addEventListener('click', async function() {
                if (!confirm('This will clear the database and fetch fresh data from the API. Continue?')) {
                    return;
                }
                
                const button = this;
                const originalTitle = button.title;
                button.style.opacity = '0.6';
                button.title = 'Refreshing...';
                
                try {
                    const response = await fetch('/api/refresh-data', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        alert(`Data refreshed successfully!\nTeams: ${data.teams_count}\nFixtures: ${data.fixtures_count}`);
                        // Reload matches
                        const matchesDataRes = await fetchMatches();
                        if (matchesDataRes) {
                            renderMatches('upcoming-matches-grid', matchesDataRes.upcoming, '', 'Upcoming');
                            renderMatches('past-matches-grid', matchesDataRes.past || [], 'past', 'Past');
                            renderMatches('most-likely-to-win-grid', matchesDataRes.most_likely_to_win, 'win', 'Likely win');
                            renderMatches('most-likely-to-lose-grid', matchesDataRes.most_likely_to_lose, 'lose', 'Likely lose');
                            updateStarredGrid();
                        }
                    } else {
                        alert(`Error: ${data.error || 'Failed to refresh data'}`);
                    }
                } catch (error) {
                    console.error('Error refreshing data:', error);
                    alert('Failed to refresh data. Please try again.');
                } finally {
                    button.style.opacity = '1';
                    button.title = originalTitle;
                }
            });
        </script>

    </body>
    </html>